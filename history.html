<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>History — FareComparator</title>
  <link rel="stylesheet" href="history.css" />
</head>
<body>
  <div class="app-shell">
    <header class="app-nav">
      <div class="app-brand"><span>FareComparator</span><span class="badge"></span></div>
      <nav class="app-nav-links">
        <a href="compare.html">Compare</a>
        <a href="history.html" class="active">History</a>
        <a href="analytics.html">Analytics</a>
      </nav>
    </header>

    <main class="app-main">
      <section class="card">
        <div class="card-header">
          <div>
            <h1 class="card-title">Search History</h1>
            <p class="text-muted">Past compare requests for a user</p>
          </div>
          <span class="chip">History API</span>
        </div>

        <div class="history-controls" style="display:flex;gap:.5rem;align-items:center;margin-bottom:.6rem;">
          <label style="font-size:.9rem;color:#6b7280">User ID</label>
          <input id="historyUserId" placeholder="1234" />
          <button id="loadHistoryBtn" class="btn btn-primary btn-sm">Load</button>
        </div>

        <div id="historyList" class="history-list">
          <div class="text-muted" style="padding:1rem">No history loaded. Click Load.</div>
        </div>
      </section>
    </main>
  </div>

<script>
    const API_BASE =
    window.location.hostname === 'localhost'
      ? ''
      : 'https://fare-backend.onrender.com';
    const loadHistoryBtn = document.getElementById('loadHistoryBtn');
    const historyList = document.getElementById('historyList');
    const historyUserId = document.getElementById('historyUserId');

    function fmtDate(ts){ try { return new Date(ts).toLocaleString(); } catch(e){return ts} }

    function renderHistory(items){
      historyList.innerHTML = '';
      if(!items || items.length===0){
        historyList.innerHTML = '<div class="text-muted" style="padding:1rem">No history found.</div>';
        return;
      }
      items.forEach(h=>{
        const div = document.createElement('div');
        div.className='history-item card';
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:600">${escapeHtml(h.tripRequest?.origin || h.origin || '-') } → ${escapeHtml(h.tripRequest?.destination || h.destination || '-')}</div>
              <div class="text-muted small">${fmtDate(h.createdAt || h.timestamp || h.date)}</div>
              <div class="text-muted small">
                CO₂ Emission: ${Number(h.co2EmissionKg || 0).toFixed(2)} kg
              </div>

              ${h.walkedDistanceKm != null ? `
                <div class="text-muted small">
                  Walked Distance: ${Number(h.walkedDistanceKm).toFixed(2)} km
                </div>
              ` : ``}

            </div>
            <div style="text-align:right">
              <div style="font-weight:700">Saved ₹ ${Number(h.savings || 0).toFixed(2)}</div>
              <div class="text-muted small">Chosen: ${escapeHtml(h.chosenProviderId || h.chosenProvider || '-')}</div>
            </div>
          </div>
          <div style="margin-top:.6rem">
            <div class="text-muted small">Providers:</div>
            <div style="display:flex;gap:.4rem;margin-top:.4rem;overflow:auto">
              ${( (h.fareEstimate || []).map(p=>`<div class="chip">${escapeHtml(p.providerName||p.providerId)} ₹${Number(p.price||0).toFixed(0)}</div>`).join('') ) }
            </div>
          </div>
        `;
        historyList.appendChild(div);
      });
    }

    function escapeHtml(s) { return String(s||'').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    async function loadHistory(){
      const userId = historyUserId.value || '1234';
      historyList.innerHTML = '<div class="text-muted" style="padding:1rem">Loading history...</div>';
      try {
        const res = await fetch(API_BASE + '/api/v1/history/' + encodeURIComponent(userId));
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        // expected array of items
        renderHistory(Array.isArray(data) ? data : (data.items || []));
      } catch(err) {
        console.error(err);
        historyList.innerHTML = '<div class="text-muted" style="padding:1rem">Failed to load history.</div>';
      }
    }

    loadHistoryBtn.addEventListener('click', loadHistory);
</script>
</body>
</html>
